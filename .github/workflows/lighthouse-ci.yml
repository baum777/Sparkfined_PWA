name: Lighthouse CI

on:
  workflow_dispatch:
    inputs:
      base_url:
        description: 'Base URL to audit (no trailing slash, defaults to prod)'
        required: false
        default: 'https://sparkfined.app'
      runs:
        description: 'Number of Lighthouse samples per URL (1-5)'
        required: false
        default: '2'

env:
  DEFAULT_PATHS: '/,/dashboard-v2,/journal-v2'

jobs:
  lighthouse:
    name: Lighthouse audit
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: read
    env:
      TARGET_BASE_URL: ${{ inputs.base_url != '' && inputs.base_url || secrets.DEPLOY_URL || 'https://sparkfined.app' }}
      RUN_COUNT: ${{ inputs.runs != '' && inputs.runs || '2' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show audit configuration
        run: |
          echo "Base URL: ${TARGET_BASE_URL}"
          echo "Runs per URL: ${RUN_COUNT}"
          echo "Paths: ${DEFAULT_PATHS}"
          {
            echo "### Lighthouse CI configuration"
            echo ""
            echo "- Base URL: ${TARGET_BASE_URL}"
            echo "- Paths: ${DEFAULT_PATHS}"
            echo "- Runs per URL: ${RUN_COUNT}"
            echo "- Budgets: lighthouse-budget.json"
            echo ""
            echo "> Update the workflow_dispatch inputs to audit preview URLs or increase the sample size."
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v11
        with:
          configPath: ./lighthouserc.json
          urls: |
            ${{ env.TARGET_BASE_URL }}
            ${{ format('{0}/dashboard-v2', env.TARGET_BASE_URL) }}
            ${{ format('{0}/journal-v2', env.TARGET_BASE_URL) }}
          runs: ${{ env.RUN_COUNT }}
          budgetPath: ./lighthouse-budget.json
          uploadArtifacts: true
          temporaryPublicStorage: true
          assertions: |
            categories:performance=warn:0.75
            categories:accessibility=error:0.90
            categories:best-practices=warn:0.90
            categories:seo=warn:0.90
            largest-contentful-paint=warn:3000
            cumulative-layout-shift=warn:0.15
